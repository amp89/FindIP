<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>IP FIND | Search</title>


		<script src="js/jquery.js"></script>
		<script src="js/test.js"></script>
		<script src="angular/angular.min.js"></script>
</head>
<body ng-app="searchApp"  ng-controller="searchForm">
	<div ng-submit="getIpInfo()">
		Enter a valid ip address, <!-- <br>&nbsp;&nbsp;&nbsp;ex: x.x.x.x, xxx.xx.xx.xxx, xxx.xxx.xxx.xxx, and so on. -->
		<form  name="ipSearchForm">
			<input name="ipAddress" type="text" ng-pattern="regex" ng-minlength="7" ng-maxlength="15" ng-model=ipSearchData.ipAddress required/>
			<button type="submit" ng-disabled="ipSearchForm.$invalid">SEARCH</button>
		</form>
		<span ng-hide="ipSearchForm.$invalid">Ip To Lookup: {{ipSearchData.ipAddress}}</span>
		<span ng-show="ipSearchForm.$invalid">Please use this format: 255.255.255.255</span>
	</div>
	<!-- end test angular -->
	
	<div ng-show="searchCompleteFlag">
		<h2>IP: {{ipResponseData.startIp}} to {{ipResponseData.endIp}}</h2>
		<h3>IP: {{ipResponseData.startIp}} to {{ipResponseData.endIp}}</h2>
		<h2>Location:</h2>
		<h3>{{ipResponseData.region}}, {{ipResponseData.city}}, {{ipResponseData.countryName}}</h3>
		<h3>Lat: {{ipResponseData.latitude}} to {{ipResponseData.longitude}}</h3>
			<form name="ipSaveForm" ng-submit="saveIp()">
			
				Public Comments (Optional):<br>
				<textarea rows="5" cols="50" ng-maxlength="10000" name="publicComments" ng-model="ipSaveData.publicComments"></textarea>
				
				Private Comments (Optional):<br>
				<textarea rows="5" cols="50" ng-maxlength="10000"  name="privateComments" ng-model="ipSaveData.privateComments"></textarea>
			
				<button type="submit" ng-disabled="ipSaveForm.$invalid">Save!</button>
				<span ng-show="ipSaveForm.$invalid">Please keep comments under 10000 characters.</span>
			</form>
		
		<div>
	</div>
	
	<!-- test rest call -->
	<script>
/* 	 old way		
	$.ajax({
		type : "GET",
		 url:"rest/getLoggedInUserData", 
		headers : {
			"Accept" : "application/json",
			"Content-Type" : "applicatoin/json"
		}
	}).done(function(data) {
		console.log(data);
		$scope.userObject = data;
	}).fail(function() {
		console.log("failed");
	}); */
	
	var app = angular.module('searchApp',[]);
	
	
	app.controller('searchForm',function($scope,$http){
		
		$scope.regex = "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])$"
		
		//request her/*  */e TODO
		$scope.ipSearchData = {};
		$scope.ipResponseData = {};
		$scope.ipSaveData = {};
		$scope.saveMessage = "";
		
		$scope.searchCompleteFlag = false;
		
		$scope.ipSearchData.accessToken="${accessToken}"
		
		//$scope.ipSearchData.accessToken = 'testjlskjfdlsdkfj';
		$scope.getIpInfo = function(){
			console.log("IP: " + $scope.ipSearchData); //TODO remove
			
			$http({
				method:"POST",
				url:"rest/getIpData",
				data:$scope.ipSearchData,
				params : {"content-type":"application/json","Accept" : "application/json"}
			}).then(function success(response){
				console.log("Post Ip search :)"); //TODO remove
				console.log(response.data); //TODO remove
				$scope.searchCompleteFlag = true;
				$scope.ipResponseData = response.data;
				
			}, function error(response){
				console.log("No post search :("); //TODO remove
			});//end http
			
		};//end get info
		
		$scope.saveIp = function(){
			console.log("save: " + $scope.ipSaveData)
			ipSaveData.userId = ${user.id};
			ipSaveData.ipId = ipResponseData.id;
			ipSaveData.acccessToken = ${accessToken};
			
			$http({
				method:"POST",
				url:"rest/saveIp",
				data:$scope.ipSearchData,
				params : {"content-type":"application/json","Accept":"application/json"}
			}).then(function success(response){
				console.log("SUCCESS POST :)")
				console.log(response.data);
				//save message TODO 
			},function error(response){
				console.log("NO SUCCESS POST :()")
				//save message TODO 
				
			});
		};//end saveIp()
		
		
	});
	
	
	
	
	
	</script>
	<!-- end test rest call -->
	
	

		
	
</body>
</html>